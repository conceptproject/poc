<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AuthenticID WebSDK 5.x ‚Äì Front/Back/Selfie Capture</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; }
    h1 { margin-bottom: .5rem; }
    .hint { color:#666; margin: 0 0 1rem; font-size:.95rem }
    .actions { display:flex; flex-wrap:wrap; gap:.75rem; margin:1rem 0 1.25rem }
    button { padding:.6rem .9rem; border-radius:.5rem; border:1px solid #ccc; background:#fff; cursor:pointer }
    button:disabled { opacity:.55; cursor:not-allowed }
    .status { margin:.25rem 0 1rem; color:#444; font-size:.95rem }
    .previews { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; }
    figure { margin:0; border:1px solid #ececec; padding:.75rem; border-radius:.5rem; background:#fafafa }
    figcaption { font-size:.85rem; color:#555; margin-top:.5rem; word-break:break-word }
    img { width:100%; height:auto; display:block; background:#ddd; border-radius:.25rem }
    code { background:#f3f3f3; padding:.1rem .35rem; border-radius:.25rem }
  </style>
</head>
<body>
  <h1>AuthenticID WebSDK ‚Äì Simple Capture</h1>
  <p class="hint">Open on <strong>HTTPS</strong> (or <code>http://localhost</code>) so the camera works.</p>

  <div class="actions">
    <button id="btn-front"  disabled>üìÑ Capture Front</button>
    <button id="btn-back"   disabled>üìÑ Capture Back</button>
    <button id="btn-selfie" disabled>ü§≥ Capture Selfie</button>
    <!-- Optional: a one-click sequence (Front ‚Üí Back ‚Üí Selfie) -->
    <button id="btn-seq"    disabled>‚ñ∂Ô∏è Run Sequence (Front ‚Üí Back ‚Üí Selfie)</button>
  </div>

  <div class="status" id="status">Loading SDK‚Ä¶</div>

  <div class="previews">
    <figure>
      <img id="img-front" alt="Front preview (cropped if available)" />
      <figcaption><strong>Front</strong> ‚Äî <span id="meta-front">no capture yet</span></figcaption>
    </figure>
    <figure>
      <img id="img-back" alt="Back preview (cropped if available)" />
      <figcaption><strong>Back</strong> ‚Äî <span id="meta-back">no capture yet</span></figcaption>
    </figure>
    <figure>
      <img id="img-selfie" alt="Selfie preview (cropped if available)" />
      <figcaption><strong>Selfie</strong> ‚Äî <span id="meta-selfie">no capture yet</span></figcaption>
    </figure>
  </div>

  <!-- Turn on very verbose SDK diagnostics BEFORE loading the SDK -->
  <script>
    window.captureFrameworkDebug = 99; // 99 = very chatty logs in console
  </script>

  <!-- Include the SDK (development/plain build) -->
  <script src="./IDMetricsCaptureFramework-4.10.0-plain-code.js"></script>

  <script>
    // ========================================================================
    // 1) SDK bootstrap (required pattern) ‚Äî the SDK calls this when loaded
    // ========================================================================
    let captureFw;

    window.onCaptureFrameworkLoaded = async function () {
      const detectionProvider = 1; // >= 4.10.0 supports "1" only
      const languageConfig = {
        lang: "en",
        localizedStrings: {
          // Keep/customize as you like; these are relevant keys for v4.10+/5.x
          notifications: {
            faceNotFound: "Face not aligned",
            tooManyFaces: "More than one face",
            moveAway: "Move away",
            moveCloser: "Move closer",
            onBlur: "Keep your phone steady to capture a clear image",
            onDark: "Please move to a brighter location or turn on more lights",
            onFaceAngleV2: "Align face within the white silhouette",
            removeLenses: "Take off your glasses",
            lenses: "Lenses detected",
            eyesClosed: "Eyes closed",
            mask: "Face mask detected",
            centerFaceV2: "Make sure you align the face within the silhouette",
            getReady: "Get ready and stay still..."
          },
          idv2: {
            capture: {
              autoCapture: "The photo will be taken automatically",
              dontMove: "Don't move your ID for a few seconds",
              fillFrameBack: "Fill the frame with your back ID",
              fillFrameFront: "Fill the frame with your ID",
              fillFramePassport: "Fill the frame with your passport",
              manualCapture: { ariaLabel: "Manual Capture", title: "Manual Capture Button" },
              notifications: {
                blur: { description: "Zoom in and out, or tap on the ID", title: "ID too blurry" },
                expiredId: "Expired ID document",
                glare: { description: "Find a better lighting to avoid reflections", title: "ID with glare" },
                notAligned: { description: "Center your ID inside the frame", title: "ID is not aligned" },
                showBack: { description: "Flip your ID to show its reverse side", title: "Show the back of ID" },
                showFront: { description: "Flip your ID to show its front side", title: "Show the front of ID" },
                useDifferent: "Use a different ID"
              },
              takingPhoto: "Taking photo..."
            },
            commonIssues: {
              firstStep: "1. Fill the frame with your ID",
              secondStep: "2. Press the button"
            },
            flipAnimation: { title: "Show the back of your ID" }
          },
          selfiev2: {
            manualCapture: {
              instructions: "Center your face in the silhouette and press the button to capture"
            }
          }
        }
      };

      captureFw = window.IDMetricsCaptureFramework;

      try {
        await captureFw.setDetectionProvider(detectionProvider, languageConfig);
        setStatus("SDK ready");
        enableButtons(true);
        console.log("[AID] SDK ready");
      } catch (err) {
        setStatus("Failed to initialize SDK: " + (err?.message || err));
        console.error("[AID] setDetectionProvider error", err);
      }
    };

    // ========================================================================
    // 2) UI wiring
    // ========================================================================
    const $ = (id) => document.getElementById(id);

    const btnFront  = $("btn-front");
    const btnBack   = $("btn-back");
    const btnSelfie = $("btn-selfie");
    const btnSeq    = $("btn-seq");

    btnFront.addEventListener("click",  () => captureIdSide("Front", $("img-front"),  $("meta-front")));
    btnBack.addEventListener("click",   () => captureIdSide("Back",  $("img-back"),   $("meta-back")));
    btnSelfie.addEventListener("click", () => captureSelfie($("img-selfie"), $("meta-selfie")));
    btnSeq.addEventListener("click",    () => runSequence());

    function enableButtons(on) {
      btnFront.disabled  = !on;
      btnBack.disabled   = !on;
      btnSelfie.disabled = !on;
      btnSeq.disabled    = !on;
    }

    function setStatus(text) {
      $("status").textContent = text;
    }

    // ========================================================================
    // 3) Capture helpers (Front/Back Selfie)
    //    - Forces single-side flow for each side to avoid the undefined crash
    //    - Very defensive when reading images from the result object
    // ========================================================================
    async function captureIdSide(side, imgEl, metaEl) {
      // Some builds use "flow", others use "mode" ‚Äî set both (harmless).
      const singleSide = side === "Front" ? "front_only" : "back_only";

      const options = {
        // Force one-side flow to match the SDK branch you saw in the stack
        flow: singleSide,
        mode: singleSide,

        // Typical doc options
        documentSide: side,          // "Front" | "Back"
        documentType: "License",     // Change to "Passport" / "PassportCard" if needed
        captureMode: "Auto"          // or "Manual" if auto-capture struggles
      };

      try {
        enableButtons(false);
        setStatus(`Capturing ${side.toLowerCase()}‚Ä¶`);

        const result = await captureFw.scanDocument(options);

        // Diagnostics so we can see what actually came back:
        const rawFront = result?.frontImage;
        const rawBack  = result?.backImage;
        console.log(`[AID] Raw ${side} images`, {
          hasFront: !!rawFront, hasBack: !!rawBack,
          frontLen: rawFront?.length, backLen: rawBack?.length
        });

        const img = pickDocImage(result, side);
        if (img) {
          imgEl.src = ensureDataUrl(img);
          metaEl.textContent = describeDocResult(result, side);
        } else {
          metaEl.textContent = `No ${side.toLowerCase()} image returned`;
        }

        console.log(`[AID] ${side} result`, result);
        setStatus(`Done: ${side}`);
      } catch (err) {
        console.error(`[AID] scanDocument(${side}) error`, err);
        setStatus(`Error capturing ${side}: ${(err && err.message) || err}`);
      } finally {
        enableButtons(true);
      }
    }

    async function captureSelfie(imgEl, metaEl) {
      try {
        enableButtons(false);
        setStatus("Capturing selfie‚Ä¶");

        const result = await captureFw.scanSelfie({
          captureMode: "Auto" // or "Manual"
        });

        const img = result?.croppedResult || result?.result || null;

        if (img) {
          imgEl.src = ensureDataUrl(img);
          metaEl.textContent = describeSelfieResult(result);
        } else {
          metaEl.textContent = "No selfie image returned";
        }

        console.log("[AID] Selfie result", result);
        setStatus("Done: Selfie");
      } catch (err) {
        console.error("[AID] scanSelfie error", err);
        setStatus(`Error capturing selfie: ${(err && err.message) || err}`);
      } finally {
        enableButtons(true);
      }
    }

    // ========================================================================
    // 4) Optional: One-click sequence (Front ‚Üí Back ‚Üí Selfie)
    //    - Tries a combined two-side flow first; if not supported, falls back
    //      to doing two single-side document calls.
    // ========================================================================
    async function runSequence() {
      enableButtons(false);
      setStatus("Starting sequence‚Ä¶");

      const out = {
        front: null, back: null, selfie: null,
        meta: { startedAt: new Date().toISOString() }
      };

      try {
        // Try a combined ID flow first (if your build supports it)
        try {
          const doc = await captureFw.scanDocument({
            flow: "front_then_back", // or "two_sides" in some builds
            mode: "front_then_back",
            documentType: "License",
            captureMode: "Auto"
          });

          // Combined flow often returns both sides; pick defensively:
          out.front = pickDocImage(doc, "Front");
          out.back  = pickDocImage(doc, "Back");
          console.log("[AID] Combined doc result", doc);

          // If one side missing, fill it with single-side calls:
          if (!out.front) {
            const frontOnly = await captureFw.scanDocument({
              flow: "front_only", mode: "front_only",
              documentSide: "Front", documentType: "License", captureMode: "Auto"
            });
            out.front = pickDocImage(frontOnly, "Front");
          }
          if (!out.back) {
            const backOnly = await captureFw.scanDocument({
              flow: "back_only", mode: "back_only",
              documentSide: "Back", documentType: "License", captureMode: "Auto"
            });
            out.back = pickDocImage(backOnly, "Back");
          }
        } catch (e) {
          // Fallback: do the two single-side calls
          console.warn("[AID] Combined flow unsupported; falling back to single-side", e);
          const frontOnly = await captureFw.scanDocument({
            flow: "front_only", mode: "front_only",
            documentSide: "Front", documentType: "License", captureMode: "Auto"
          });
          out.front = pickDocImage(frontOnly, "Front");

          const backOnly = await captureFw.scanDocument({
            flow: "back_only", mode: "back_only",
            documentSide: "Back", documentType: "License", captureMode: "Auto"
          });
          out.back = pickDocImage(backOnly, "Back");
        }

        // Selfie
        const face = await captureFw.scanSelfie({ captureMode: "Auto" });
        out.selfie = face?.croppedResult || face?.result || null;

        // Render to previews (if we got them)
        if (out.front) $("img-front").src = ensureDataUrl(out.front);
        if (out.back)  $("img-back").src  = ensureDataUrl(out.back);
        if (out.selfie) $("img-selfie").src = ensureDataUrl(out.selfie);

        $("meta-front").textContent  = out.front  ? "Front captured"  : "Front missing";
        $("meta-back").textContent   = out.back   ? "Back captured"   : "Back missing";
        $("meta-selfie").textContent = out.selfie ? "Selfie captured" : "Selfie missing";

        console.log("[AID] Sequence output", out);
        setStatus("Sequence complete");
      } catch (err) {
        console.error("[AID] Sequence error", err);
        setStatus(`Sequence failed: ${(err && err.message) || err}`);
      } finally {
        enableButtons(true);
      }
    }

    // ========================================================================
    // 5) Utilities
    // ========================================================================
    function ensureDataUrl(data) {
      if (typeof data === "string" && data.startsWith("data:")) return data;
      return "data:image/jpeg;base64," + data;
    }

    function pickDocImage(r, side) {
      // Prefer cropped, then per-side cropped, then general, then raw per-side
      const candidates = [
        r?.croppedResult,
        side === "Front" ? r?.croppedFrontImage : r?.croppedBackImage,
        r?.result,
        side === "Front" ? r?.frontImage : r?.backImage
      ];
      const first = candidates.find(x => typeof x === "string" && x.length > 20);
      return first || null;
    }

    function describeDocResult(r, side) {
      const focus  = r?.frontFocus ?? r?.backFocus;
      const glare  = r?.frontGlare ?? r?.backGlare;
      const bits = [
        typeof focus === "number" ? `focus=${focus}` : null,
        typeof glare === "number" ? `glare=${glare}` : null
      ].filter(Boolean).join(", ");
      return `${side} captured${bits ? ` (${bits})` : ""}`;
    }

    function describeSelfieResult(_) {
      return "Selfie captured";
    }
  </script>
</body>
</html>
