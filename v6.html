<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>IDMetrics 4.10.1 POC</title>
  <style>
    .imgContainer { border: 2px solid; text-align: center; padding: 40px; }
    code { display: inline-block; width: 100px; }
    .box { width: 500px; word-wrap: break-word; font-size: 10px; }
    .actions { border: 1px solid; margin-top: 40px; padding: 20px }
    .btn { background-color: #4CAF50; border: none; color: white; padding: 15px 32px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; }
    .blue { background-color: #3D5AFE; }
    .red { background-color: #F7412C; }
    .purple { background-color: #6834BC; }
    .black { background-color: #555555; }
    .form-container { max-width: 500px; width: 100%; padding: 50px 30px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); }
    .form-group { position: relative; margin-bottom: 20px; }
    .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; transition: border-color 0.3s ease; }
    .form-group label { position: absolute; left: 12px; top: 12px; font-size: 14px; color: #777; transition: top 0.3s ease, font-size 0.3s ease, color 0.3s ease; }
    .form-group input:focus { border-color: #007bff; outline: none; }
    .form-group input:focus+label,
    .form-group input:not(:placeholder-shown)+label {
      top: -6px; font-size: 12px; color: #007bff; background-color: #ffffff; padding: 0 4px; border-radius: 4px; left: 8px;
    }
  </style>

  <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  <!-- Load the 4.10.1 SDK (plain-code) -->
  <script defer src="./IDMetricsCaptureFramework-4.10.1-plain-code.js"></script>

  <script>
    let captureFw = undefined;
    let frameworkReady = false;

    // 4.10.x: SDK calls this when its JS bundle is loaded.
    window.onCaptureFrameworkLoaded = async function () {
      try {
        // In 4.10.x the only supported provider is 1
        const detectionProvider = 1;

        const languageConfig = {
          lang: "en",
          localizedStrings: {
            notifications: {
              faceNotFound: "Face not aligned",
              tooManyFaces: "More than one face",
              moveAway: "Move away",
              moveCloser: "Move closer",
              onBlur: "Keep your phone steady to capture a clear image",
              onDark: "Please move to a brighter location or turn on more lights",
              onFaceAngleV2: "Align face within the white silhouette",
              removeLenses: "Take off your glasses",
              lenses: "Lenses detected",
              eyesClosed: "Eyes closed",
              mask: "Face mask detected",
              centerFaceV2: "Make sure you align the face within the silhouette",
              getReady: "Get ready and stay still..."
            },
            idv2: {
              capture: {
                autoCapture: "The photo will be taken automatically",
                dontMove: "Don't move your ID for a few seconds",
                fillFrameBack: "Fill the frame with your back ID",
                fillFrameFront: "Fill the frame with your ID",
                fillFramePassport: "Fill the frame with your passport",
                manualCapture: { ariaLabel: "Manual Capture", title: "Manual Capture Button" },
                notifications: {
                  blur: { description: "Zoom in and out, or tap on the ID", title: "ID too blurry" },
                  expiredId: "Expired ID document",
                  glare: { description: "Find a better lighting to avoid reflections", title: "ID with glare" },
                  notAligned: { description: "Center your ID inside the frame", title: "ID is not aligned" },
                  showBack: { description: "Flip your ID to show its reverse side", title: "Show the back of ID" },
                  showFront: { description: "Flip your ID to show its front side", title: "Show the front of ID" },
                  useDifferent: "Use a different ID"
                },
                takingPhoto: "Taking photo..."
              },
              commonIssues: { firstStep: "1. Fill the frame with your ID", secondStep: "2. Press the button" },
              flipAnimation: { title: "Show the back of your ID" }
            },
            selfiev2: {
              manualCapture: { instructions: "Center your face in the silhouette and press the button to capture" }
            }
          }
        };

        captureFw = window.IDMetricsCaptureFramework;

        // IMPORTANT: 4.10 init – this also boots the WASM/cpp engine
        await captureFw.setDetectionProvider(detectionProvider, languageConfig);

        frameworkReady = true;
        console.log("IDMetrics 4.10.1 initialized");

        // Enable buttons now that the framework is initialized
        document.getElementById("front").disabled = false;
        document.getElementById("back").disabled = false;
        document.getElementById("selfie").disabled = false;

      } catch (err) {
        console.error("Framework init failed", err);
        alert("Framework init failed: " + (err?.message || err));
      }
    };

    function initializeCaptureFramework() {
      // You can keep this button to simulate “load framework”.
      // With 4.10.x the actual readiness comes from onCaptureFrameworkLoaded + setDetectionProvider above.
      if (!window.IDMetricsCaptureFramework) {
        alert("SDK not loaded yet. Wait for the script or check the path.");
        return;
      }
      alert("SDK script loaded; initialization will complete automatically.");
    }

    function ensureReady() {
      if (!frameworkReady) {
        alert("Framework is not ready yet. Please wait a moment and try again.");
        throw new Error("Framework not ready");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const captureResult = new CaptureResult();
      const documentSettings = new DocumentSettings();

      // Initially disable buttons until frameworkReady is true
      document.getElementById("front").disabled = true;
      document.getElementById("back").disabled = true;
      document.getElementById("selfie").disabled = true;

      captureResult.setOnAborted((abortEvent) => {
        console.log("abort", abortEvent);
      });

      captureResult.setOnFinish(() => {
        if (captureResult.isSuccessful) {
          console.log("capture success", captureResult);
          const img = new Image();
          img.style.width = "300px";
          img.style.height = "auto";
          img.src = captureResult.result;
          document.getElementById("frontImg").appendChild(img);
        } else {
          console.log("capture not successful", captureResult);
        }
      });

      captureResult.setOnEvent((errorCode, errorDescription, event) => {
        console.log("onEvent", event, errorDescription);
      });

      captureResult.setOnCaptureModeChange((captureModeEvent) => {
        console.log("modeChange", captureModeEvent);
      });

      // FRONT
      document.getElementById("front").addEventListener("click", async () => {
        ensureReady();

        documentSettings.captureMode = "Auto";
        documentSettings.documentType = "License";
        documentSettings.captureModeText = true;
        documentSettings.documentSide = "Front";
        documentSettings.frontFocusThreshold = 30;
        documentSettings.frontGlareThreshold = 2.5;
        documentSettings.compressionType = "JPEG";
        documentSettings.compressionQuality = 70;
        documentSettings.overlayTextAuto = "Align ID and tap <br/> to capture.";
        documentSettings.overlayText = "Align ID within box and capture";
        documentSettings.overlayColor = "yellow";
        documentSettings.enableFaceDetection = true;
        documentSettings.setManualTimeout = 15;
        documentSettings.enableLocationDetection = true;
        documentSettings.autoCaptureCheckNFrames = 2;

        try {
          await window.IDMetricsCaptureFramework.scanDocument(documentSettings, captureResult);
        } catch (e) {
          console.error("scanDocument(front) failed:", e);
        }
      });

      // BACK
      document.getElementById("back").addEventListener("click", async () => {
        ensureReady();

        documentSettings.captureMode = "Auto";
        documentSettings.documentType = "License";
        documentSettings.captureModeText = true;
        documentSettings.documentSide = "Back";
        documentSettings.frontFocusThreshold = 30;
        documentSettings.frontGlareThreshold = 2.5;
        documentSettings.compressionType = "JPEG";
        documentSettings.compressionQuality = 70;
        documentSettings.overlayTextAuto = "Align ID and tap <br/> to capture.";
        documentSettings.overlayText = "Align ID within box and capture";
        documentSettings.overlayColor = "yellow";
        documentSettings.enableFaceDetection = true;
        documentSettings.setManualTimeout = 15;
        documentSettings.enableLocationDetection = true;
        documentSettings.autoCaptureCheckNFrames = 2;

        try {
          await window.IDMetricsCaptureFramework.scanDocument(documentSettings, captureResult);
        } catch (e) {
          console.error("scanDocument(back) failed:", e);
        }
      });

      // SELFIE
      document.getElementById("selfie").addEventListener("click", async () => {
        ensureReady();

        documentSettings.captureMode = "Auto";
        documentSettings.captureModeText = true;
        documentSettings.enableFarSelfie = true;

        try {
          await window.IDMetricsCaptureFramework.scanSelfie(documentSettings, captureResult);
        } catch (e) {
          console.error("scanSelfie failed:", e);
        }
      });
    });
  </script>
</head>

<body>
  <div>
    <input type="hidden" id="deviceKeyInput" value="testkey">
    <button id="loadFrameworkButton" class="btn black" onclick="initializeCaptureFramework()">Load Framework</button>
    <p><small><i>Instructions: Tap “Load Framework” (optional). Once the SDK finishes initializing, use the buttons below to capture Front, Back, and Selfie images.</i></small></p>
  </div>

  <div class="actions">
    <button id="front" class="btn blue">Scan Document Front</button>
    <button id="back" class="btn red">Scan Document Back</button>
    <button id="selfie" class="btn purple">Capture Selfie</button>

    <div id="frontImg" class="imgContainer"></div>
    <div class="box"><p id="base64Value"></p></div>
  </div>
</body>
</html>
